---
layout: post
title: "OTA升级流程"
date:   2020-09-08
tags: [geek]
comments: true
author: thomaszeng
---

OTA升级流程,客户端只需调用RecoverySystem.installPackage(Context context,File packageFile)方法，将OTA包的路径传递到installPackage方法中，Android系统将重启，然后进行自动升级。
这一过程，在应用层要处理的逻辑比较简单，而底层的实现原理比较复杂，由于近期在做Pad升级相关的功能，所以打算对OTA升级进行一个简单的总结。

## 开始

我们先在源码中查找到RecoverySystem.java所在的路径，位于 frameworks/base/core/java/android/os/RecoverySystem.java

```
在应用层下载OTA升级包后，会调用RecoverySystem.installPackage(Context context,File packageFile)方法
来发起安装过程，这个过程的主要原理，实际上是王/cache/recovery/command写入OTA升级包的路径，然后重启到recovery模式，
仅此而已。
```
```
public static void installPackage(Context context, File packageFile)
    throws IOException {
    String filename = packageFile.getCanonicalPath();
    Log.w(TAG, "!!! REBOOTING TO INSTALL " + filename + " !!!");
 
    //升级包路径
    final String filenameArg = "--update_package=" + filename;
    final String localeArg = "--locale=" + Locale.getDefault().toString();
    bootCommand(context, filenameArg, localeArg);
}

private static void bootCommand(Context context, String... args) throws IOException {
    RECOVERY_DIR.mkdirs();  // In case we need it
    COMMAND_FILE.delete();  // In case it's not writable
    LOG_FILE.delete();
    FileWriter command = new FileWriter(COMMAND_FILE);
    try {
        for (String arg : args) {
            if (!TextUtils.isEmpty(arg)) {
                command.write(arg);
                command.write("\n");
            }
        }
    } finally {
        command.close();
    }
    // Having written the command file, go ahead and reboot
    PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
    //重启到recovery模式
    pm.reboot(PowerManager.REBOOT_RECOVERY);
    throw new IOException("Reboot failed (no permissions?)");
}
```
